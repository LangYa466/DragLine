/*
 * LiquidBounce Hacked Client
 * A free open source mixin-based injection hacked client for Minecraft using Minecraft Forge.
 * https://github.com/CCBlueX/LiquidBounce/
 */
package dragline.features.module.modules.exploit;

import dragline.event.*;
import dragline.utils.MinecraftInstance;
import dragline.api.minecraft.client.network.IINetHandlerPlayClient;
import dragline.api.minecraft.network.IPacket;
import dragline.api.minecraft.network.play.client.ICPacketPlayer;
import dragline.api.minecraft.util.IAxisAlignedBB;
import dragline.api.minecraft.util.WBlockPos;
import dragline.event.*;
import dragline.features.module.Module;
import dragline.features.module.ModuleCategory;
import dragline.features.module.ModuleInfo;
import dragline.utils.MovementUtils;
import dragline.utils.block.BlockUtils;
import dragline.utils.timer.TickTimer;
import dragline.value.ListValue;

@ModuleInfo(name = "Phase", description = "Allows you to walk through blocks.", category = ModuleCategory.EXPLOIT)
public class Phase extends Module {

    private final ListValue modeValue = new ListValue("Mode", new String[] {"Vanilla", "Skip", "Spartan", "Clip", "AAC3.5.0", "Mineplex"}, "Vanilla");

    private final TickTimer tickTimer = new TickTimer();

    private boolean mineplexClip;
    private final TickTimer mineplexTickTimer = new TickTimer();

    @EventTarget
    public void onUpdate(final UpdateEvent event) {
        final boolean isInsideBlock = BlockUtils.collideBlockIntersects(MinecraftInstance.mc.getThePlayer().getEntityBoundingBox(), block -> !MinecraftInstance.classProvider.isBlockAir(block));

        if(isInsideBlock && !modeValue.get().equalsIgnoreCase("Mineplex")) {
            MinecraftInstance.mc.getThePlayer().setNoClip(true);
            MinecraftInstance.mc.getThePlayer().setMotionY(0D);
            MinecraftInstance.mc.getThePlayer().setOnGround(false);
        }

        IINetHandlerPlayClient netHandlerPlayClient = MinecraftInstance.mc.getNetHandler();

        switch(modeValue.get().toLowerCase()) {
            case "vanilla": {
                if (!MinecraftInstance.mc.getThePlayer().getOnGround() || !tickTimer.hasTimePassed(2) || !MinecraftInstance.mc.getThePlayer().isCollidedVertically() || !(!isInsideBlock || MinecraftInstance.mc.getThePlayer().isSneaking()))
                    break;

                netHandlerPlayClient.addToSendQueue(MinecraftInstance.classProvider.createCPacketPlayerPosition(MinecraftInstance.mc.getThePlayer().getPosX(), MinecraftInstance.mc.getThePlayer().getPosY(), MinecraftInstance.mc.getThePlayer().getPosZ(), true));
                netHandlerPlayClient.addToSendQueue(MinecraftInstance.classProvider.createCPacketPlayerPosition(0.5D, 0, 0.5D, true));
                netHandlerPlayClient.addToSendQueue(MinecraftInstance.classProvider.createCPacketPlayerPosition(MinecraftInstance.mc.getThePlayer().getPosX(), MinecraftInstance.mc.getThePlayer().getPosY(), MinecraftInstance.mc.getThePlayer().getPosZ(), true));
                netHandlerPlayClient.addToSendQueue(MinecraftInstance.classProvider.createCPacketPlayerPosition(MinecraftInstance.mc.getThePlayer().getPosX(), MinecraftInstance.mc.getThePlayer().getPosY() + 0.2D, MinecraftInstance.mc.getThePlayer().getPosZ(), true));
                netHandlerPlayClient.addToSendQueue(MinecraftInstance.classProvider.createCPacketPlayerPosition(0.5D, 0, 0.5D, true));
                netHandlerPlayClient.addToSendQueue(MinecraftInstance.classProvider.createCPacketPlayerPosition(MinecraftInstance.mc.getThePlayer().getPosX() + 0.5D, MinecraftInstance.mc.getThePlayer().getPosY(), MinecraftInstance.mc.getThePlayer().getPosZ() + 0.5D, true));
                final double yaw = Math.toRadians(MinecraftInstance.mc.getThePlayer().getRotationYaw());
                final double x = -Math.sin(yaw) * 0.04D;
                final double z = Math.cos(yaw) * 0.04D;
                MinecraftInstance.mc.getThePlayer().setPosition(MinecraftInstance.mc.getThePlayer().getPosX() + x, MinecraftInstance.mc.getThePlayer().getPosY(), MinecraftInstance.mc.getThePlayer().getPosZ() + z);
                tickTimer.reset();
                break;
            }
            case "skip": {
                if (!MinecraftInstance.mc.getThePlayer().getOnGround() || !tickTimer.hasTimePassed(2) || !MinecraftInstance.mc.getThePlayer().isCollidedVertically() || !(!isInsideBlock || MinecraftInstance.mc.getThePlayer().isSneaking()))
                    break;

                final double direction = MovementUtils.getDirection();
                final double posX = -Math.sin(direction) * 0.3;
                final double posZ = Math.cos(direction) * 0.3;

                for (int i = 0; i < 3; ++i) {
                    MinecraftInstance.mc.getNetHandler().addToSendQueue(MinecraftInstance.classProvider.createCPacketPlayerPosition(MinecraftInstance.mc.getThePlayer().getPosX(), MinecraftInstance.mc.getThePlayer().getPosY() + 0.06, MinecraftInstance.mc.getThePlayer().getPosZ(), true));
                    MinecraftInstance.mc.getNetHandler().addToSendQueue(MinecraftInstance.classProvider.createCPacketPlayerPosition(MinecraftInstance.mc.getThePlayer().getPosX() + posX * i, MinecraftInstance.mc.getThePlayer().getPosY(), MinecraftInstance.mc.getThePlayer().getPosZ() + posZ * i, true));
                }

                MinecraftInstance.mc.getThePlayer().setEntityBoundingBox(MinecraftInstance.mc.getThePlayer().getEntityBoundingBox().offset(posX, 0.0D, posZ));
                MinecraftInstance.mc.getThePlayer().setPositionAndUpdate(MinecraftInstance.mc.getThePlayer().getPosX() + posX, MinecraftInstance.mc.getThePlayer().getPosY(), MinecraftInstance.mc.getThePlayer().getPosZ() + posZ);
                tickTimer.reset();
                break;
            }
            case "spartan": {
                if (!MinecraftInstance.mc.getThePlayer().getOnGround() || !tickTimer.hasTimePassed(2) || !MinecraftInstance.mc.getThePlayer().isCollidedVertically() || !(!isInsideBlock || MinecraftInstance.mc.getThePlayer().isSneaking()))
                    break;

                netHandlerPlayClient.addToSendQueue(MinecraftInstance.classProvider.createCPacketPlayerPosition(MinecraftInstance.mc.getThePlayer().getPosX(), MinecraftInstance.mc.getThePlayer().getPosY(), MinecraftInstance.mc.getThePlayer().getPosZ(), true));
                netHandlerPlayClient.addToSendQueue(MinecraftInstance.classProvider.createCPacketPlayerPosition(0.5D, 0, 0.5D, true));
                netHandlerPlayClient.addToSendQueue(MinecraftInstance.classProvider.createCPacketPlayerPosition(MinecraftInstance.mc.getThePlayer().getPosX(), MinecraftInstance.mc.getThePlayer().getPosY(), MinecraftInstance.mc.getThePlayer().getPosZ(), true));
                netHandlerPlayClient.addToSendQueue(MinecraftInstance.classProvider.createCPacketPlayerPosition(MinecraftInstance.mc.getThePlayer().getPosX(), MinecraftInstance.mc.getThePlayer().getPosY() - 0.2D, MinecraftInstance.mc.getThePlayer().getPosZ(), true));
                netHandlerPlayClient.addToSendQueue(MinecraftInstance.classProvider.createCPacketPlayerPosition(0.5D, 0, 0.5D, true));
                netHandlerPlayClient.addToSendQueue(MinecraftInstance.classProvider.createCPacketPlayerPosition(MinecraftInstance.mc.getThePlayer().getPosX() + 0.5D, MinecraftInstance.mc.getThePlayer().getPosY(), MinecraftInstance.mc.getThePlayer().getPosZ() + 0.5D, true));
                final double yaw = Math.toRadians(MinecraftInstance.mc.getThePlayer().getRotationYaw());
                final double x = -Math.sin(yaw) * 0.04D;
                final double z = Math.cos(yaw) * 0.04D;
                MinecraftInstance.mc.getThePlayer().setPosition(MinecraftInstance.mc.getThePlayer().getPosX() + x, MinecraftInstance.mc.getThePlayer().getPosY(), MinecraftInstance.mc.getThePlayer().getPosZ() + z);
                tickTimer.reset();
                break;
            }
            case "clip": {
                if (!tickTimer.hasTimePassed(2) || !MinecraftInstance.mc.getThePlayer().isCollidedVertically() || !(!isInsideBlock || MinecraftInstance.mc.getThePlayer().isSneaking()))
                    break;

                final double yaw = Math.toRadians(MinecraftInstance.mc.getThePlayer().getRotationYaw());
                final double oldX = MinecraftInstance.mc.getThePlayer().getPosX();
                final double oldZ = MinecraftInstance.mc.getThePlayer().getPosZ();

                for (int i = 1; i <= 10; i++) {
                    final double x = -Math.sin(yaw) * i;
                    final double z = Math.cos(yaw) * i;

                    if (MinecraftInstance.classProvider.isBlockAir(BlockUtils.getBlock(new WBlockPos(oldX + x, MinecraftInstance.mc.getThePlayer().getPosY(), oldZ + z))) && MinecraftInstance.classProvider.isBlockAir(BlockUtils.getBlock(new WBlockPos(oldX + x, MinecraftInstance.mc.getThePlayer().getPosY() + 1, oldZ + z)))) {
                        MinecraftInstance.mc.getThePlayer().setPosition(oldX + x, MinecraftInstance.mc.getThePlayer().getPosY(), oldZ + z);
                        break;
                    }
                }
                tickTimer.reset();
                break;
            }
            case "aac3.5.0": {
                if (!tickTimer.hasTimePassed(2) || !MinecraftInstance.mc.getThePlayer().isCollidedVertically() || !(!isInsideBlock || MinecraftInstance.mc.getThePlayer().isSneaking()))
                    break;

                final double yaw = Math.toRadians(MinecraftInstance.mc.getThePlayer().getRotationYaw());
                final double oldX = MinecraftInstance.mc.getThePlayer().getPosX();
                final double oldZ = MinecraftInstance.mc.getThePlayer().getPosZ();
                final double x = -Math.sin(yaw);
                final double z = Math.cos(yaw);

                MinecraftInstance.mc.getThePlayer().setPosition(oldX + x, MinecraftInstance.mc.getThePlayer().getPosY(), oldZ + z);
                tickTimer.reset();
                break;
            }
        }

        tickTimer.update();
    }

    @EventTarget
    public void onBlockBB(final BlockBBEvent event) {
        if (MinecraftInstance.mc.getThePlayer() != null && BlockUtils.collideBlockIntersects(MinecraftInstance.mc.getThePlayer().getEntityBoundingBox(), block -> !MinecraftInstance.classProvider.isBlockAir(block)) && event.getBoundingBox() != null && event.getBoundingBox().getMaxY() > MinecraftInstance.mc.getThePlayer().getEntityBoundingBox().getMinY() && !modeValue.get().equalsIgnoreCase("Mineplex")) {
            final IAxisAlignedBB axisAlignedBB = event.getBoundingBox();

            event.setBoundingBox(MinecraftInstance.classProvider.createAxisAlignedBB(axisAlignedBB.getMaxX(), MinecraftInstance.mc.getThePlayer().getEntityBoundingBox().getMinY(), axisAlignedBB.getMaxZ(), axisAlignedBB.getMinX(), axisAlignedBB.getMinY(), axisAlignedBB.getMinZ()));
        }
    }

    @EventTarget
    public void onPacket(final PacketEvent event) {
        final IPacket packet = event.getPacket();

        if (MinecraftInstance.classProvider.isCPacketPlayer(packet)) {
            ICPacketPlayer packetPlayer = packet.asCPacketPlayer();

            if (modeValue.get().equalsIgnoreCase("AAC3.5.0")) {
                final float yaw = (float) MovementUtils.getDirection();

                packetPlayer.setX(packetPlayer.getX() - Math.sin(yaw) * 0.00000001D);
                packetPlayer.setZ(packetPlayer.getZ() + Math.cos(yaw) * 0.00000001D);
            }
        }
    }

    @EventTarget
    private void onMove(final MoveEvent event) {
        if (modeValue.get().equalsIgnoreCase("mineplex")) {
            if (MinecraftInstance.mc.getThePlayer().isCollidedVertically())
                mineplexClip = true;
            if (!mineplexClip)
                return;

            mineplexTickTimer.update();

            event.setX(0);
            event.setZ(0);

            if (mineplexTickTimer.hasTimePassed(3)) {
                mineplexTickTimer.reset();
                mineplexClip = false;
            } else if (mineplexTickTimer.hasTimePassed(1)) {
                final double offset = mineplexTickTimer.hasTimePassed(2) ? 1.6D : 0.06D;
                final double direction = MovementUtils.getDirection();

                MinecraftInstance.mc.getThePlayer().setPosition(MinecraftInstance.mc.getThePlayer().getPosX() + (-Math.sin(direction) * offset), MinecraftInstance.mc.getThePlayer().getPosY(), MinecraftInstance.mc.getThePlayer().getPosZ() + (Math.cos(direction) * offset));
            }
        }
    }

    @EventTarget
    public void onPushOut(PushOutEvent event) {
        event.cancelEvent();
    }

    @Override
    public String getTag() {
        return modeValue.get();
    }
}
